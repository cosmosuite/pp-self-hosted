version: "3.9"

# ──────────────────────────────────────────────────────────────────────────────
# Local development: runs all 3 services together.
#
# In production:
#   - compute → Hetzner VPS (compute/docker-compose.yml)
#   - middleware + frontend → Railway (separate services)
# ──────────────────────────────────────────────────────────────────────────────

services:
  compute:
    build: ./compute
    ports:
      - "8000:8000"
    environment:
      - COMPUTE_API_KEY=${COMPUTE_API_KEY:-dev-secret}
    volumes:
      - compute-models:/app/models
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  middleware:
    build: ./middleware
    ports:
      - "4000:4000"
    environment:
      - PORT=4000
      - COMPUTE_URL=http://compute:8000
      - COMPUTE_API_KEY=${COMPUTE_API_KEY:-dev-secret}
      - ALLOWED_ORIGINS=http://localhost:5173,http://localhost:3000
      - AUTUMN_ENABLED=${AUTUMN_ENABLED:-false}
      - AUTUMN_SECRET_KEY=${AUTUMN_SECRET_KEY:-}
      - DATABASE_URL=${DATABASE_URL:-}
      - R2_ACCOUNT_ID=${R2_ACCOUNT_ID:-}
      - R2_ACCESS_KEY_ID=${R2_ACCESS_KEY_ID:-}
      - R2_SECRET_ACCESS_KEY=${R2_SECRET_ACCESS_KEY:-}
      - R2_BUCKET_NAME=${R2_BUCKET_NAME:-safevision}
      - R2_PUBLIC_URL=${R2_PUBLIC_URL:-}
    depends_on:
      compute:
        condition: service_healthy
    restart: unless-stopped

  frontend:
    build:
      context: ./frontend
      args:
        VITE_API_URL: http://localhost:4000
    ports:
      - "3000:3000"
    depends_on:
      - middleware
    restart: unless-stopped

volumes:
  compute-models:
